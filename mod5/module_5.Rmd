---
title: 'Module 5: Introduction to MLM'
author: "Phil Mike Jones"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath("~/gits/multi_level_modelling/"))
options(scipen = 5, digits = 2)
```

```{r packages}
library("readr")
library("lme4")
library("broom")
```

# P5.1: Comparing Groups using Multilevel Modelling

Course content copyright 2011 Camille Szmaragd and George Leckie, Centre for Multilevel Modelling

Load Scottish School Leavers Survey (SSLS) data

```{r read-ssls, warning=FALSE, cache=TRUE, message=FALSE}
ssls <- readr::read_csv("inst/extdata/5.1.txt")
head(ssls)
```

Tidy dataset and configure factors
```{r tidy-ssls}
ssls$female <- factor(ssls$female, levels = 0:1, labels = c("male", "female"))
ssls$sclass <- factor(ssls$sclass, levels = 1:4,
                      labels = c("managerial", "intermediate", "working",
                                 "unclassified"))
ssls$schtype <- factor(ssls$schtype, levels = 0:1,
                       labels = c("independent", "state"))
ssls$schurban <- factor(ssls$schurban, levels = 0:1,
                        labels = c("town_rural", "urban"))
ssls$schdenom <- factor(ssls$schdenom, levels = 0:1,
                        labels = c("non-denom", "roman_catholic"))
```

```{r check-ssls}
head(ssls)
tail(ssls)
```

## P5.1.1 A multi--level model of attainment with school effects

Set up a null model using only school effects. The null model in general is:

$$
score_{ij} = \beta_{o} + u_{oj} + e_{ij}
$$

where $score_{ij}$ is the attainment of student $i$ in school $j$, $\beta_{o}$ is the overall mean across schools, $u_{oj}$ is the effect of school $j$ on attainment, and $e_{ij}$ is student $ij$'s error term or residual.
The null model therefore attempts to explain student ${ij}$'s attainment by taking the mean, adjusting based on the attainment of the school they attend, and including an error term.

```{r null-model}
m_null <- lmer(score ~ (1 | schoolid), data = ssls, REML = FALSE)
```

In setting up the null model no fixed effects are included and the intercept is included by default.
The `(1 | schoolid)` refers to the constant (`1`) and random level 2 explanatory variables (`schoolid`).
The constant is an integer greater than or equal to one, with the greater the value the more accurate the estimation of the log--likelihood at the cost of greater computational time.
`REML = FALSE` uses a maximum likelihood estimation rather than a restricted maximum likelihood estimation, the default.

```{r null-summary}
summary(m_null)
```

Formula displays the call used for the model.
Data provides summary statistics for the model.
Random effects show the effects of random effect variables on the model, in this case only `schoolid`.
Fixed effects shows the effect of fixed effect variables on the model, in this case just an intercept.
From the fixed effects the mean attainment value across all schools is estimated as `r m_null@beta`.
The mean for school $j$ is therefore estimated as $`r m_null@beta` + \hat{u}_{oj}$, where $+ \hat{u}_{oj}$ is the school residual.

<!-- ## P5.1.2 Examining school effects (residuals) -->

<!-- ```{r school-effects} -->
<!-- fit <- lm(score ~ 1, data = ssls) -->
<!-- summary(fit) -->
<!-- ``` -->

<!-- logLik(m_null) -->
<!-- logLik(fit) -->

<!-- u0 <- ranef(m_null, postVar = TRUE) -->

<!-- u0se <- sqrt(attr(u0[[1]], "postVar")[1, , ]) -->

<!-- str(u0[1]) -->

<!-- str(u0[[1]]) -->

<!-- head(attr(u0[[1]], "postVar")[1, , ]) -->

<!-- schoolid <- as.numeric(rownames(u0[[1]])) -->

<!-- u0tab <- cbind(schoolid, u0[[1]], u0se) -->

<!-- colnames(u0tab) <- c("schoolid","u0","u0se") -->

<!-- u0tab <- u0tab[order(u0tab$u0), ] -->

<!-- u0tab <- cbind(u0tab, c(1:dim(u0tab)[1])) -->

<!-- colnames(u0tab)[4] <- "u0rank" -->

<!-- u0tab <- u0tab[order(u0tab$schoolid), ] -->

<!-- u0tab[1:10, ] -->

<!-- plot(u0tab$u0rank, u0tab$u0, type = "n", xlab = "u_rank", ylab = "conditional modes of r.e. for school_id:_cons") -->

<!-- segments(u0tab$u0rank, u0tab$u0 - 1.96*u0tab$u0se, u0tab$u0rank, u0tab$u0 + 1.96*u0tab$u0se) -->

<!-- points(u0tab$u0rank, u0tab$u0, col = "blue") -->

<!-- abline(h = 0, col = "red") -->
