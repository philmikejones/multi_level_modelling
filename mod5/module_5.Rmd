---
title: 'Module 5: Introduction to MLM'
author: "Phil Mike Jones"
date: "1 August 2016"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath("~/gits/multi_level_modelling/"))
```

```{r packages}
library("readr")
library("lubridate")
library("lme4")
```

# P5.1: Comparing Groups using Multilevel Modelling

Copyright 2011 Camille Szmaragd and George Leckie, Centre for Multilevel
Modelling

Load Scottish School Leavers Survey (SSLS) data

```{r read-ssls}
ssls <- readr::read_csv("inst/extdata/5.1.txt")
head(ssls)
```

Tidy dataset and configure factors
```{r tidy-ssls}
ssls$female   <- factor(ssls$female, levels = 0:1, labels = c("male", "female"))
ssls$sclass   <- factor(ssls$sclass, levels = 1:4,
                        labels = c("managerial", "intermediate", "working",
                                   "unclassified"))
ssls$schtype  <- factor(ssls$schtype, levels = 0:1,
                        labels = c("independent", "state"))
ssls$schurban <- factor(ssls$schurban, levels = 0:1,
                        labels = c("town_rural", "urban"))
ssls$schdenom <- factor(ssls$schdenom, levels = 0:1,
                        labels = c("non-denom", "roman_catholic"))
```

## P5.1.1 A multilevel model of attainment with school effects

```{r null-model}
nullmodel <- lmer(score ~ (1 | schoolid), data = ssls, REML = FALSE)
summary(nullmodel)
```

## P5.1.2 Examining school effects (residuals)

```{r school-effects}
fit <- lm(score ~ 1, data = ssls)
summary(fit)
```

logLik(nullmodel)
logLik(fit)

u0 <- ranef(nullmodel, postVar = TRUE)

u0se <- sqrt(attr(u0[[1]], "postVar")[1, , ])

str(u0[1])

str(u0[[1]])

head(attr(u0[[1]], "postVar")[1, , ])

schoolid <- as.numeric(rownames(u0[[1]]))

u0tab <- cbind(schoolid, u0[[1]], u0se)

colnames(u0tab) <- c("schoolid","u0","u0se")

u0tab <- u0tab[order(u0tab$u0), ]

u0tab <- cbind(u0tab, c(1:dim(u0tab)[1]))

colnames(u0tab)[4] <- "u0rank"

u0tab <- u0tab[order(u0tab$schoolid), ]

u0tab[1:10, ]

plot(u0tab$u0rank, u0tab$u0, type = "n", xlab = "u_rank", ylab = "conditional modes of r.e. for school_id:_cons")

segments(u0tab$u0rank, u0tab$u0 - 1.96*u0tab$u0se, u0tab$u0rank, u0tab$u0 + 1.96*u0tab$u0se)

points(u0tab$u0rank, u0tab$u0, col = "blue")

abline(h = 0, col = "red")
